name: Move to Staging and Create PR

on:
  workflow_call:
            

jobs:
  move-and-create-pr:
    name: Move Installer to Staging and Create PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with: 
          ref: main

      - name: Move Installer to Staging
        shell: bash
        run: |
          mkdir -p infrastructure/terraform/scripts/staging
          mv solutions/CN.Shared.JokeService/JokeService/bin/Release/net8.0-windows/win-x64/publish/JokeService.exe infrastructure/terraform/scripts/staging

      - name: Close Old Autogenerated PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_list=$(gh pr list --search "Autogenerated - Publish exe to staging in:title" --state open --json number --jq '.[].number')
          if [ -z "$pr_list" ]; then
            echo "No open PRs found."
          else
            for pr_number in $pr_list; do
              echo "Closing PR #$pr_number"
              gh pr close "$pr_number" -c "Closing outdated autogenerated PR."
            done
          fi
        shell: bash

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-pr-${{ github.event.pull_request.number }}-${{ github.event.pull_request.merge_commit_sha }}
          base: main
          title: Autogenerated - Publish exe to staging
          body: Files generated by merging ${{ github.event.pull_request.html_url }}
          commit-message: Publish exe
