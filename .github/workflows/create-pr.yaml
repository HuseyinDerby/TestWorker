name: Move to Staging and Create PR

on:
  workflow_call:
    inputs:
      publish-dir:
        description: "Path to the published files directory"
        required: true
      staging-path:
        description: "Path to the staging directory"
        required: true
      pr-title:
        description: "Title of the autogenerated pull request"
        default: "Autogenerated - Publish exe to staging"
      pr-body:
        description: "Body of the autogenerated pull request"
        default: "Files generated from the latest workflow run."
      branch-prefix:
        description: "Prefix for the branch created for the PR"
        default: "auto-pr"
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  move-and-create-pr:
    name: Move Installer to Staging and Create PR
    runs-on: ubuntu-latest
    steps:
      - name: Move Installer to Staging
        run: |
          mkdir -p ${{ inputs.staging-path }}
          mv ${{ inputs.publish-dir }}/* ${{ inputs.staging-path }}
        shell: bash

      - name: Close Old Autogenerated PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_list=$(gh pr list --search "${{ inputs.pr-title }} in:title" --state open --json number --jq '.[].number')
          if [ -z "$pr_list" ]; then
            echo "No open PRs found."
          else
            for pr_number in $pr_list; do
              echo "Closing PR #$pr_number"
              gh pr close "$pr_number" -c "Closing outdated autogenerated PR."
            done
          fi
        shell: bash

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ inputs.branch-prefix }}-${{ github.sha }}
          base: main
          title: ${{ inputs.pr-title }}
          body: ${{ inputs.pr-body }}
          commit-message: ${{ inputs.pr-title }}
