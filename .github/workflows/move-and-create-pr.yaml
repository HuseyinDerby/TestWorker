name: Move and Create PR

on:
    workflow_call:


jobs:
    move-and-create-pr:
        runs-on: windows-latest
        steps:
          - name: Download Artifact
            uses: actions/download-artifact@v3
            with:
                name: published-output

          - name: Move Installer to Staging
            shell: bash
            run: |
                mkdir -p infrastructure/terraform/scripts/staging
                mv JokeService.exe infrastructure/terraform/scripts/staging/

          - name: Close Old Autogenerated PRs
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            shell: bash
            run: |
                pr_list=$(gh pr list --search "Autogenerated - Publish exe to staging in:title" --state open --json number --jq '.[].number')
                if [ -z "$pr_list" ]; then
                    echo "No open PRs starting with 'Autogenerated' found."
                else
                    echo "Found the following PRs to close:"
                    echo "$pr_list"
                    for pr_number in $pr_list; do
                        echo "Closing PR #$pr_number"
                        gh pr close "$pr_number" -c "Closing outdated autogenerated PR."
                    done
                fi

          - name: Create Pull Request
            uses: peter-evans/create-pull-request@v7
            with:
                token: ${{ secrets.GITHUB_TOKEN }}
                branch: auto-pr-${{ github.run_id }}-${{ github.sha }}
                base: main
                title: Autogenerated - Publish exe to staging
                body: Files generated by merging ${{ github.event.pull_request.html_url }}
                commit-message: Publish exe
